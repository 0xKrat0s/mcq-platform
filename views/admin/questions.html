<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Questions - Admin Panel</title>
    <link rel="stylesheet" href="/css/style.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- EasyMDE Markdown Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <style>
        /* Clean Editor Styles */
        .EasyMDEContainer {
            border: 1px solid #d6d3d1;
            border-radius: 6px;
            overflow: hidden;
        }
        .editor-toolbar {
            background: #fff;
            border: none;
            border-bottom: 1px solid #e7e5e4;
            padding: 8px;
            opacity: 1;
        }
        .editor-toolbar::before,
        .editor-toolbar::after {
            display: none;
        }
        .editor-toolbar button {
            color: #57534e !important;
            border: none !important;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            margin: 0 1px;
        }
        .editor-toolbar button:hover {
            background: #f5f5f4 !important;
            border: none !important;
        }
        .editor-toolbar button.active {
            background: #eff6ff !important;
            color: #2563eb !important;
        }
        .editor-toolbar i.separator {
            border-left: 1px solid #e7e5e4;
            border-right: none;
            margin: 0 6px;
        }
        .EasyMDEContainer .CodeMirror {
            border: none;
            border-radius: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            padding: 8px 12px;
            height: 160px;
            background: #fff;
        }
        .EasyMDEContainer .CodeMirror-focused {
            outline: none;
        }
        .EasyMDEContainer .CodeMirror-scroll {
            min-height: 120px;
        }
        .editor-statusbar {
            background: #fafaf9;
            border-top: 1px solid #e7e5e4;
            padding: 4px 12px;
            font-size: 11px;
            color: #a8a29e;
        }
        .editor-preview,
        .editor-preview-side {
            background: #fff;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .editor-preview-side {
            border-left: 1px solid #e7e5e4;
        }

        /* Markdown rendering */
        .markdown-body { line-height: 1.6; }
        .markdown-body img { max-width: 100%; height: auto; border-radius: 4px; margin: 8px 0; }
        .markdown-body code { background: #f5f5f4; padding: 2px 5px; border-radius: 3px; font-size: 0.875em; color: #44403c; }
        .markdown-body pre { background: #292524; color: #e7e5e4; padding: 12px; border-radius: 6px; overflow-x: auto; margin: 8px 0; }
        .markdown-body pre code { background: none; padding: 0; color: inherit; }
        .markdown-body blockquote { border-left: 3px solid #d6d3d1; margin: 8px 0; padding: 8px 12px; color: #57534e; }

        /* Option display in question list */
        .option-row {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: #f5f5f4;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #44403c;
        }
        .option-row.correct {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }
        .option-row strong {
            color: #292524;
            margin-right: 6px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="../dashboard" class="navbar-brand">MCQ Admin</a>
        <ul class="navbar-nav">
            <li><a href="../dashboard">Dashboard</a></li>
            <li><a href="../exams" class="active">Exams</a></li>
            <li><a href="../results">Results</a></li>
            <li><a href="../settings">Settings</a></li>
            <li><a href="../logout">Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <div>
                    <a href="../exams" class="text-muted">&larr; Back to Exams</a>
                    <h2 class="card-title mt-2" id="exam-title">Loading...</h2>
                    <p class="text-muted" id="exam-code"></p>
                </div>
                <button class="btn btn-primary" onclick="openCreateModal()">Add Question</button>
            </div>

            <div id="alert-container"></div>

            <div id="questions-list">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <div id="empty-state" class="empty-state hidden">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3>No Questions Yet</h3>
                <p>Click "Add Question" to create your first question</p>
            </div>
        </div>
    </div>

    <!-- Create/Edit Question Modal -->
    <div class="modal-overlay" id="question-modal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Add Question</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>

            <form id="question-form">
                <input type="hidden" id="question-id">

                <div class="form-group">
                    <label class="form-label" for="question_text">Question * <span class="text-muted" style="font-weight: normal; font-size: 12px;">(Markdown supported - add images, code, formatting)</span></label>
                    <textarea class="form-control" id="question_text" rows="3" placeholder="Enter your question here. Use **bold**, *italic*, `code`, ![image](url)"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Options *</label>
                    <div style="display: grid; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: #f5f5f4; border-radius: 4px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; color: #57534e; flex-shrink: 0;">A</span>
                            <input type="text" class="form-control" id="option_a" required placeholder="Option A">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: #f5f5f4; border-radius: 4px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; color: #57534e; flex-shrink: 0;">B</span>
                            <input type="text" class="form-control" id="option_b" required placeholder="Option B">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: #f5f5f4; border-radius: 4px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; color: #57534e; flex-shrink: 0;">C</span>
                            <input type="text" class="form-control" id="option_c" required placeholder="Option C">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: #f5f5f4; border-radius: 4px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; color: #57534e; flex-shrink: 0;">D</span>
                            <input type="text" class="form-control" id="option_d" required placeholder="Option D">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="correct_option">Correct Answer *</label>
                        <select class="form-control" id="correct_option" required>
                            <option value="">Select correct answer</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="marks">Marks</label>
                        <input type="number" class="form-control" id="marks" value="1" min="1">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">Add Question</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Delete Question</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <p>Are you sure you want to delete this question?</p>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Markdown libraries -->
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <script>
        const examId = window.location.pathname.split('/').pop();
        let questions = [];
        let exam = null;
        let editingId = null;
        let deletingId = null;
        let easyMDE = null;

        // Escape HTML for options display
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Render markdown safely
        function renderMarkdown(text) {
            if (!text) return '';
            const rawHtml = marked.parse(text);
            return DOMPurify.sanitize(rawHtml);
        }

        // Upload image to server
        async function uploadImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const response = await fetch('/api/upload-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: e.target.result })
                        });
                        const data = await response.json();
                        if (data.success) {
                            resolve(data.url);
                        } else {
                            reject(new Error(data.message));
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Initialize markdown editor
        function initEditor() {
            if (easyMDE) {
                easyMDE.toTextArea();
                easyMDE = null;
            }

            easyMDE = new EasyMDE({
                element: document.getElementById('question_text'),
                spellChecker: false,
                status: ['lines', 'words'],
                placeholder: 'Write your question here... (supports markdown)',
                minHeight: '160px',
                toolbar: [
                    'bold', 'italic', 'heading', '|',
                    'code', 'quote', '|',
                    'unordered-list', 'ordered-list', '|',
                    'link',
                    {
                        name: 'upload-image',
                        action: function(editor) {
                            const input = document.createElement('input');
                            input.type = 'file';
                            input.accept = 'image/*';
                            input.onchange = async function() {
                                if (input.files && input.files[0]) {
                                    try {
                                        const url = await uploadImage(input.files[0]);
                                        const cm = editor.codemirror;
                                        const pos = cm.getCursor();
                                        cm.replaceRange(`![image](${url})`, pos);
                                    } catch (error) {
                                        alert('Failed to upload image: ' + error.message);
                                    }
                                }
                            };
                            input.click();
                        },
                        className: 'fa fa-image',
                        title: 'Upload Image'
                    },
                    'table', '|',
                    'preview', 'fullscreen'
                ],
                previewRender: function(plainText) {
                    return DOMPurify.sanitize(marked.parse(plainText));
                },
                uploadImage: true,
                imageUploadFunction: async function(file, onSuccess, onError) {
                    try {
                        const url = await uploadImage(file);
                        onSuccess(url);
                    } catch (error) {
                        onError(error.message);
                    }
                }
            });

            // Add paste handler for images
            easyMDE.codemirror.on('paste', async function(cm, e) {
                const items = e.clipboardData?.items;
                if (!items) return;

                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = items[i].getAsFile();
                        try {
                            const url = await uploadImage(file);
                            const pos = cm.getCursor();
                            cm.replaceRange(`![image](${url})`, pos);
                        } catch (error) {
                            alert('Failed to upload image: ' + error.message);
                        }
                        break;
                    }
                }
            });

            // Add drop handler for images
            easyMDE.codemirror.on('drop', async function(cm, e) {
                const files = e.dataTransfer?.files;
                if (!files || files.length === 0) return;

                for (let i = 0; i < files.length; i++) {
                    if (files[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        try {
                            const url = await uploadImage(files[i]);
                            const pos = cm.coordsChar({ left: e.pageX, top: e.pageY });
                            cm.replaceRange(`![image](${url})\n`, pos);
                        } catch (error) {
                            alert('Failed to upload image: ' + error.message);
                        }
                    }
                }
            });
        }

        async function loadExam() {
            try {
                const response = await fetch(`/api/exams/${examId}`);
                exam = await response.json();

                document.getElementById('exam-title').textContent = exam.title;
                document.getElementById('exam-code').textContent = `Code: ${exam.exam_code}`;
                document.title = `Questions - ${exam.title}`;
            } catch (error) {
                console.error('Failed to load exam:', error);
            }
        }

        async function loadQuestions() {
            try {
                const response = await fetch(`/api/exams/${examId}/questions`);
                questions = await response.json();
                renderQuestions();
            } catch (error) {
                console.error('Failed to load questions:', error);
            }
        }

        function renderQuestions() {
            const container = document.getElementById('questions-list');
            const emptyState = document.getElementById('empty-state');

            if (questions.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = questions.map((q, index) => `
                <div class="card" style="margin-bottom: 1rem;">
                    <div class="d-flex justify-between align-center mb-3">
                        <div class="d-flex gap-2">
                            <span class="badge badge-info">#${index + 1}</span>
                            <span class="badge badge-success">${q.marks} pt${q.marks > 1 ? 's' : ''}</span>
                        </div>
                        <div class="actions">
                            <button class="btn btn-sm btn-outline" onclick="editQuestion(${q.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDelete(${q.id})">Delete</button>
                        </div>
                    </div>
                    <div class="markdown-body" style="margin-bottom: 1rem;">${renderMarkdown(q.question_text)}</div>
                    <div style="display: grid; gap: 6px;">
                        <div class="option-row ${q.correct_option === 'A' ? 'correct' : ''}">
                            <strong>A.</strong> ${escapeHtml(q.option_a)}
                        </div>
                        <div class="option-row ${q.correct_option === 'B' ? 'correct' : ''}">
                            <strong>B.</strong> ${escapeHtml(q.option_b)}
                        </div>
                        <div class="option-row ${q.correct_option === 'C' ? 'correct' : ''}">
                            <strong>C.</strong> ${escapeHtml(q.option_c)}
                        </div>
                        <div class="option-row ${q.correct_option === 'D' ? 'correct' : ''}">
                            <strong>D.</strong> ${escapeHtml(q.option_d)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openCreateModal() {
            editingId = null;
            document.getElementById('modal-title').textContent = 'Add Question';
            document.getElementById('submit-btn').textContent = 'Add Question';
            document.getElementById('question-form').reset();
            document.getElementById('marks').value = exam ? exam.marks_per_question : 1;
            document.getElementById('question-modal').classList.add('active');

            // Initialize editor after modal is visible
            setTimeout(() => {
                initEditor();
                easyMDE.value('');
            }, 100);
        }

        function editQuestion(id) {
            const question = questions.find(q => q.id === id);
            if (!question) return;

            editingId = id;
            document.getElementById('modal-title').textContent = 'Edit Question';
            document.getElementById('submit-btn').textContent = 'Update Question';

            document.getElementById('question-id').value = question.id;
            document.getElementById('option_a').value = question.option_a;
            document.getElementById('option_b').value = question.option_b;
            document.getElementById('option_c').value = question.option_c;
            document.getElementById('option_d').value = question.option_d;
            document.getElementById('correct_option').value = question.correct_option;
            document.getElementById('marks').value = question.marks;

            document.getElementById('question-modal').classList.add('active');

            // Initialize editor and set value after modal is visible
            setTimeout(() => {
                initEditor();
                easyMDE.value(question.question_text);
            }, 100);
        }

        function closeModal() {
            document.getElementById('question-modal').classList.remove('active');
            if (easyMDE) {
                easyMDE.toTextArea();
                easyMDE = null;
            }
        }

        document.getElementById('question-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const questionText = easyMDE ? easyMDE.value() : document.getElementById('question_text').value;

            if (!questionText.trim()) {
                showAlert('danger', 'Question text is required');
                return;
            }

            const data = {
                question_text: questionText,
                option_a: document.getElementById('option_a').value,
                option_b: document.getElementById('option_b').value,
                option_c: document.getElementById('option_c').value,
                option_d: document.getElementById('option_d').value,
                correct_option: document.getElementById('correct_option').value,
                marks: parseInt(document.getElementById('marks').value)
            };

            const btn = document.getElementById('submit-btn');
            btn.disabled = true;

            try {
                let url = `/api/exams/${examId}/questions`;
                let method = 'POST';

                if (editingId) {
                    url = `/api/questions/${editingId}`;
                    method = 'PUT';
                }

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    closeModal();
                    loadQuestions();
                    showAlert('success', editingId ? 'Question updated!' : 'Question added!');
                } else {
                    showAlert('danger', result.message);
                }
            } catch (error) {
                showAlert('danger', 'An error occurred. Please try again.');
            }

            btn.disabled = false;
        });

        function confirmDelete(id) {
            deletingId = id;
            document.getElementById('delete-modal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('active');
        }

        document.getElementById('confirm-delete-btn').addEventListener('click', async function() {
            if (!deletingId) return;

            try {
                const response = await fetch(`/api/questions/${deletingId}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    closeDeleteModal();
                    loadQuestions();
                    showAlert('success', 'Question deleted!');
                }
            } catch (error) {
                showAlert('danger', 'Failed to delete question');
            }
        });

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        loadExam();
        loadQuestions();
    </script>
</body>
</html>
